@using LX.TestPad.Business.Models;
@model ResultModel

@{
    ViewData["Title"] = "Test result";

    var testScore = @Model.Score;
}

<div class="text-center">
    <h1 class="display-4">Test Result</h1>
    <h4 class="display-4">@testScore%</h4>

</div>

<div class="my-5">
    <canvas id="pieChart"></canvas>
</div>


<a class="btn btn-outline-primary" href="@Url.Action("Index", "Home")">Back to tests</a>

<button class="btn btn-outline-secondary" onclick="copyResultLink()">Share result</button>


<div id="message" style="display: none;">Time's up</div>

<div id="notification" style="display: none;">Link to your result was copied to clipboard</div>


@section scripts{
    <script type="text/javascript">

        var thisResultId = @ViewBag.ResultId;
        var isTestExpired = @ViewBag.IsExpired;

        $(document).ready(function () {
            var scorePercent = @testScore;
            renderPieChart('pieChart', scorePercent);

            if (isTestExpired == 1){
                showResultExpired();
            }
        })


        
        var isExpiredMsgShown = false;
        function showResultExpired(){
            if(!isExpiredMsgShown){
                isExpiredMsgShown = true;
                var popupRemainFor = 2; //seconds

                $("#message").fadeIn("slow");

                var sec = 0;
                var timer = setInterval(function() { 
                    if(sec++ >= popupRemainFor){
                        $("#message").fadeOut("slow");
                        clearInterval(timer);
                        isExpiredMsgShown = false;
                        return;
                    }
                }, 1000);
            }
        }



        var isCopiedMsgShown = false;
        function copyResultLink(){

            var resultLink = window.location.origin + "/Result?resultId=" + thisResultId;
            navigator.clipboard.writeText(resultLink);

            if(!isCopiedMsgShown){
                isCopiedMsgShown = true;
                var popupRemainFor = 3; //seconds

                $("#notification").fadeIn("slow");

                var sec = 0;
                var timer = setInterval(function() { 
                    if(sec++ >= popupRemainFor){
                        $("#notification").fadeOut("slow");
                        clearInterval(timer);
                        isCopiedMsgShown = false;
                        return;
                    }
                }, 1000);
            }
        }



        var start_angle = 0;
        var total_value = 100;

        function renderPieChart(canvasId, scorePercent){
            var chartCanvas = document.getElementById(canvasId);
            chartCanvas.width = 300;
            chartCanvas.height = 300;
            var ctx = chartCanvas.getContext("2d");

            var pieRadius = Math.min(chartCanvas.width/2, chartCanvas.height/2);
            pieRadius -= pieRadius/10;
            var centerX = chartCanvas.width/2;
            var centerY = chartCanvas.height/2;

            var correctAnswersColor = '#508c36';
            var wrongAnswersColor = '#ef891f';

            var fillPoint = 2 * Math.PI;
            
            var angle = (2 * Math.PI * scorePercent) / total_value;
            drawPieSlice(ctx, centerX, centerY, pieRadius, 0, angle, correctAnswersColor);
            drawSlicePercentage(chartCanvas, ctx, scorePercent);

            drawPieSlice(ctx, centerX, centerY, pieRadius, angle, fillPoint, wrongAnswersColor);
        }


        function drawPieSlice(ctx,centerX, centerY, radius, startAngle, endAngle, color ){
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.moveTo(centerX,centerY);
            ctx.arc(centerX, centerY, radius, startAngle, endAngle);
            ctx.closePath();
            ctx.fill();
        }


        function drawSlicePercentage(canvas, ctx, percent){
			slice_angle = 2 * Math.PI * percent / total_value;
			var pieRadius = Math.min(canvas.width/2, canvas.height/2);
			var labelX = canvas.width/2 + (pieRadius / 2) * Math.cos(start_angle + slice_angle/2);
			var labelY = canvas.height/2 + (pieRadius / 2) * Math.sin(start_angle + slice_angle/2);
			
			var labelText = Math.round(100 * percent / total_value);
			ctx.fillStyle = "white";
			ctx.font = "bold 20px Arial";
			ctx.fillText(labelText+"%", labelX, labelY);

			start_angle += slice_angle;
        }

    </script>

}